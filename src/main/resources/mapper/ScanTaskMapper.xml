<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.musicwebdav.infrastructure.persistence.mapper.ScanTaskMapper">

    <insert id="insert" parameterType="ScanTaskEntity" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO scan_task(task_type, status, config_id, total_files, audio_files, added_count,
                updated_count, deleted_count, failed_count, processed_directories, total_directories, progress_pct)
        VALUES(#{taskType}, #{status}, #{configId}, #{totalFiles}, #{audioFiles}, #{addedCount},
                #{updatedCount}, #{deletedCount}, #{failedCount}, #{processedDirectories}, #{totalDirectories}, #{progressPct})
    </insert>

    <select id="selectById" resultType="ScanTaskEntity">
        SELECT id, task_type, status, config_id, start_time, end_time, total_files, audio_files,
            added_count, updated_count, deleted_count, failed_count,
            processed_directories, total_directories, last_synced_dir, progress_pct,
            error_summary, created_at, updated_at
        FROM scan_task WHERE id = #{id}
    </select>

    <select id="selectStatusById" resultType="java.lang.String">
        SELECT status FROM scan_task WHERE id = #{id}
    </select>

    <select id="countActiveByConfigId" resultType="int">
        SELECT COUNT(1) FROM scan_task
        WHERE config_id = #{configId} AND status IN ('PENDING','RUNNING')
    </select>

    <update id="markRunning">
        UPDATE scan_task SET status = #{status}, start_time = NOW(), updated_at = NOW()
        WHERE id = #{id} AND status = 'PENDING'
    </update>

    <update id="markFinished">
        UPDATE scan_task SET status = #{status}, end_time = NOW(), total_files = #{totalFiles},
            audio_files = #{audioFiles}, added_count = #{addedCount}, updated_count = #{updatedCount},
            deleted_count = #{deletedCount}, failed_count = #{failedCount}, error_summary = #{errorSummary},
            updated_at = NOW() WHERE id = #{id} AND status = 'RUNNING'
    </update>

    <update id="markFailedBeforeRunning">
        UPDATE scan_task SET status = #{status}, end_time = NOW(), failed_count = #{failedCount},
            error_summary = #{errorSummary}, updated_at = NOW()
        WHERE id = #{id} AND status = 'PENDING'
    </update>

    <update id="cancel">
        UPDATE scan_task SET status = #{status}, end_time = NOW(), updated_at = NOW()
        WHERE id = #{id} AND status IN ('PENDING','RUNNING')
    </update>

    <update id="updateCanceledStats">
        UPDATE scan_task SET total_files = #{totalFiles}, audio_files = #{audioFiles},
            added_count = #{addedCount}, updated_count = #{updatedCount}, deleted_count = #{deletedCount},
            failed_count = #{failedCount}, error_summary = #{errorSummary}, updated_at = NOW()
        WHERE id = #{id} AND status = 'CANCELED'
    </update>

    <update id="updateProgress">
        UPDATE scan_task SET
            total_files = #{totalFiles}, audio_files = #{audioFiles},
            added_count = #{addedCount}, updated_count = #{updatedCount},
            failed_count = #{failedCount},
            processed_directories = #{processedDirectories},
            total_directories = #{totalDirectories},
            last_synced_dir = #{lastSyncedDir},
            progress_pct = #{progressPct},
            updated_at = NOW()
        WHERE id = #{id} AND status = 'RUNNING'
    </update>

</mapper>
