<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>WebDAV 管理台</title>
    <style>
        :root {
            --bg: #f6f7fb;
            --panel: #ffffff;
            --line: #d9deea;
            --text: #1f2937;
            --sub: #6b7280;
            --primary: #0f766e;
            --danger: #b91c1c;
            --soft: #eef2ff;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: "Avenir Next", "PingFang SC", "Hiragino Sans GB", sans-serif;
        }

        .page {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px 14px 28px;
        }

        h1 {
            margin: 0 0 6px;
            font-size: 26px;
        }

        .desc {
            color: var(--sub);
            margin: 0 0 16px;
            font-size: 14px;
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 14px;
        }

        .controls {
            display: grid;
            grid-template-columns: 1.6fr 1fr auto auto auto auto auto;
            gap: 8px;
            align-items: center;
        }

        input, select {
            width: 100%;
            height: 38px;
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 0 10px;
            font-size: 14px;
            background: #fff;
            color: var(--text);
        }

        button {
            height: 38px;
            border: 0;
            border-radius: 10px;
            padding: 0 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-soft {
            background: var(--soft);
            color: #3730a3;
        }

        .btn-danger {
            background: #fee2e2;
            color: var(--danger);
        }

        .path {
            margin: 12px 2px 10px;
            padding: 8px 10px;
            border: 1px dashed var(--line);
            border-radius: 10px;
            font-size: 13px;
            color: var(--sub);
            background: #fcfcff;
            word-break: break-all;
        }

        .list {
            display: grid;
            gap: 8px;
        }

        .row {
            display: grid;
            grid-template-columns: 24px 1fr auto;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 10px;
            background: #fff;
        }

        .row-name {
            font-size: 14px;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .status {
            margin-top: 10px;
            min-height: 22px;
            color: var(--sub);
            font-size: 13px;
        }

        .status.error {
            color: var(--danger);
        }

        @media (max-width: 900px) {
            .controls {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
    </style>
</head>
<body>
<div class="page">
    <h1>WebDAV 管理台</h1>
    <p class="desc">支持目录浏览、目录删除，以及触发增量/全量同步任务。</p>

    <div class="card">
        <div class="controls">
            <input id="token" value="dev-token" placeholder="Bearer Token">
            <select id="configSelect"></select>
            <button id="loadConfigBtn" class="btn-soft">加载配置</button>
            <button id="refreshBtn" class="btn-soft">刷新目录</button>
            <button id="upBtn" class="btn-soft">上级目录</button>
            <button id="syncIncBtn" class="btn-primary">增量同步</button>
            <button id="syncFullBtn" class="btn-primary">全量同步</button>
        </div>

        <div class="path" id="currentPath">当前目录：/</div>

        <div class="controls" style="grid-template-columns: auto;">
            <button id="deleteBtn" class="btn-danger">删除选中目录</button>
        </div>

        <div id="dirList" class="list"></div>
        <div id="status" class="status"></div>
    </div>
</div>

<script>
    const state = {
        configId: null,
        currentPath: "",
        selectedPath: "",
        dirs: []
    };

    const tokenEl = document.getElementById("token");
    const configSelectEl = document.getElementById("configSelect");
    const loadConfigBtn = document.getElementById("loadConfigBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const upBtn = document.getElementById("upBtn");
    const syncIncBtn = document.getElementById("syncIncBtn");
    const syncFullBtn = document.getElementById("syncFullBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const dirListEl = document.getElementById("dirList");
    const currentPathEl = document.getElementById("currentPath");
    const statusEl = document.getElementById("status");

    function headers(hasJsonBody) {
        const token = tokenEl.value.trim();
        const h = {};
        if (token) {
            h["Authorization"] = "Bearer " + token;
        }
        if (hasJsonBody) {
            h["Content-Type"] = "application/json";
        }
        return h;
    }

    async function api(url, options) {
        const resp = await fetch(url, options || {});
        const json = await resp.json().catch(() => null);
        if (!json) {
            throw new Error("接口返回不是 JSON");
        }
        if (json.code !== "0") {
            throw new Error(json.message || "请求失败");
        }
        return json.data;
    }

    function setStatus(text, isError) {
        statusEl.textContent = text || "";
        statusEl.classList.toggle("error", !!isError);
    }

    function ensureConfigSelected() {
        const val = configSelectEl.value;
        if (!val) {
            throw new Error("请先选择 WebDAV 配置");
        }
        state.configId = Number(val);
    }

    function updatePathView() {
        currentPathEl.textContent = "当前目录：/" + (state.currentPath || "");
    }

    function renderDirectories() {
        dirListEl.innerHTML = "";
        if (!state.dirs.length) {
            const empty = document.createElement("div");
            empty.className = "row";
            empty.innerHTML = "<div></div><div class='row-name'>当前目录下没有子文件夹</div><div></div>";
            dirListEl.appendChild(empty);
            return;
        }

        state.dirs.forEach((dir) => {
            const row = document.createElement("div");
            row.className = "row";
            const checked = state.selectedPath === dir.relativePath ? "checked" : "";
            row.innerHTML =
                "<input type='radio' name='selectedDir' " + checked + ">" +
                "<div class='row-name' title='" + escapeHtml(dir.relativePath) + "'>" +
                escapeHtml(dir.name) +
                "</div>" +
                "<button class='btn-soft'>进入</button>";

            const radio = row.querySelector("input");
            const enterBtn = row.querySelector("button");
            radio.addEventListener("change", () => {
                state.selectedPath = dir.relativePath;
            });
            enterBtn.addEventListener("click", () => {
                state.currentPath = dir.relativePath;
                state.selectedPath = "";
                loadDirectories().catch((e) => setStatus(e.message, true));
            });
            row.addEventListener("click", (e) => {
                if (e.target.tagName !== "BUTTON") {
                    radio.checked = true;
                    state.selectedPath = dir.relativePath;
                }
            });

            dirListEl.appendChild(row);
        });
    }

    function escapeHtml(str) {
        return String(str || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    async function loadConfigs() {
        setStatus("正在加载配置...");
        const configs = await api("/api/v1/webdav/configs", {
            headers: headers(false)
        });
        configSelectEl.innerHTML = "";
        configs.forEach((cfg) => {
            const option = document.createElement("option");
            option.value = cfg.id;
            option.textContent = "#" + cfg.id + " " + cfg.name + " (" + cfg.rootPath + ")";
            configSelectEl.appendChild(option);
        });
        if (!configs.length) {
            setStatus("没有可用的 WebDAV 配置，请先创建配置", true);
            return;
        }
        state.configId = Number(configSelectEl.value);
        setStatus("配置加载完成");
    }

    async function loadDirectories() {
        ensureConfigSelected();
        updatePathView();
        setStatus("正在读取目录...");
        let url = "/api/v1/webdav/configs/" + state.configId + "/directories";
        if (state.currentPath) {
            url += "?path=" + encodeURIComponent(state.currentPath);
        }
        state.dirs = await api(url, { headers: headers(false) });
        renderDirectories();
        setStatus("目录已更新，共 " + state.dirs.length + " 个子目录");
    }

    function parentPath(path) {
        if (!path) {
            return "";
        }
        const arr = path.split("/");
        arr.pop();
        return arr.join("/");
    }

    async function deleteSelectedDirectory() {
        ensureConfigSelected();
        if (!state.selectedPath) {
            throw new Error("请先选择要删除的文件夹");
        }
        const ok = window.confirm("确认删除文件夹？\n" + state.selectedPath + "\n此操作不可恢复。");
        if (!ok) {
            return;
        }
        setStatus("正在删除目录...");
        const url = "/api/v1/webdav/configs/" + state.configId + "/directories?path=" + encodeURIComponent(state.selectedPath);
        await api(url, {
            method: "DELETE",
            headers: headers(false)
        });
        if (state.currentPath === state.selectedPath) {
            state.currentPath = parentPath(state.currentPath);
        }
        state.selectedPath = "";
        await loadDirectories();
        setStatus("目录删除成功");
    }

    async function triggerSync(taskType) {
        ensureConfigSelected();
        setStatus("正在触发 " + taskType + " 同步...");
        const data = await api("/api/v1/scan/tasks", {
            method: "POST",
            headers: headers(true),
            body: JSON.stringify({
                taskType: taskType,
                configId: state.configId
            })
        });
        setStatus(taskType + " 同步任务已创建，taskId=" + data.taskId);
    }

    loadConfigBtn.addEventListener("click", async () => {
        try {
            state.currentPath = "";
            state.selectedPath = "";
            state.configId = Number(configSelectEl.value);
            await loadDirectories();
        } catch (e) {
            setStatus(e.message, true);
        }
    });

    refreshBtn.addEventListener("click", async () => {
        try {
            await loadDirectories();
        } catch (e) {
            setStatus(e.message, true);
        }
    });

    upBtn.addEventListener("click", async () => {
        try {
            state.currentPath = parentPath(state.currentPath);
            state.selectedPath = "";
            await loadDirectories();
        } catch (e) {
            setStatus(e.message, true);
        }
    });

    deleteBtn.addEventListener("click", async () => {
        try {
            await deleteSelectedDirectory();
        } catch (e) {
            setStatus(e.message, true);
        }
    });

    syncIncBtn.addEventListener("click", async () => {
        try {
            await triggerSync("INCREMENTAL");
        } catch (e) {
            setStatus(e.message, true);
        }
    });

    syncFullBtn.addEventListener("click", async () => {
        try {
            await triggerSync("FULL");
        } catch (e) {
            setStatus(e.message, true);
        }
    });

    (async function init() {
        try {
            await loadConfigs();
            await loadDirectories();
        } catch (e) {
            setStatus(e.message, true);
        }
    })();
</script>
</body>
</html>
