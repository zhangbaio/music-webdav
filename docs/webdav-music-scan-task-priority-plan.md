# WebDAV 音频扫描工具开发任务拆分（按优先级）

## 1. 说明
- 依据文档：
  - `docs/webdav-music-scan-requirements.md`
  - `docs/webdav-music-scan-development-design.md`
- 优先级定义：
  - `P0`：上线必需，不完成无法形成可用产品
  - `P1`：高价值增强，建议首版上线前完成
  - `P2`：优化与演进，可放到后续迭代

## 2. 里程碑视图
1. 迭代一（P0）：打通“可扫描、可入库、可查询”
2. 迭代二（P1）：增强稳定性、可观测性与运维能力
3. 迭代三（P2）：性能与体验优化

## 3. P0 任务（上线阻断项）

### P0-1 项目骨架与基础依赖
- 目标：初始化 Spring Boot 工程，接入 MyBatis、Sardine、jaudiotagger、Liquibase。
- 前置依赖：无
- 交付物：
  - `pom.xml` 依赖完整可编译
  - 分层目录骨架（api/application/domain/infrastructure）
- 验收标准：
  - 本地启动成功
  - `/actuator/health` 可访问

### P0-2 数据库与 Liquibase 初始化
- 目标：落地 `webdav_config/scan_task/scan_task_item/scan_task_seen_file/track` 五张核心表。
- 前置依赖：P0-1
- 交付物：
  - `db/changelog/db.changelog-master.yaml`
  - 初始化 SQL changelog 文件
- 验收标准：
  - 空库执行 `Liquibase update` 成功
  - 表结构、索引与设计文档一致

### P0-3 WebDAV 配置与连接测试
- 目标：实现 WebDAV 配置管理和连接测试接口。
- 前置依赖：P0-1、P0-2
- 交付物：
  - `POST /api/v1/webdav/test`
  - 配置持久化（密码加密存储）
- 验收标准：
  - 正确账号返回成功
  - 错误账号返回鉴权错误码

### P0-4 全量扫描主链路
- 目标：递归遍历目录、过滤音频文件、读取文件元数据、写入 track。
- 前置依赖：P0-3
- 交付物：
  - 扫描执行服务
  - 批量 upsert SQL
  - 基础错误处理
- 验收标准：
  - 目标目录可完成全量扫描
  - `track` 数据数量与可识别音频数一致（损坏文件除外）

### P0-5 音频标签解析与字段回退
- 目标：使用 jaudiotagger 解析标题/歌手/专辑/时长等，缺失字段按规则回退。
- 前置依赖：P0-4
- 交付物：
  - metadata parser 组件
  - 回退策略实现（Unknown Artist/Album）
- 验收标准：
  - 常见格式（mp3/flac/m4a）可解析
  - 缺失标签不会导致入库失败

### P0-6 任务管理与状态机
- 目标：任务创建、运行状态更新、完成汇总。
- 前置依赖：P0-4
- 交付物：
  - `POST /api/v1/scan/tasks`
  - `GET /api/v1/scan/tasks/{id}`
- 验收标准：
  - 状态流转符合 `PENDING->RUNNING->SUCCESS|FAILED|PARTIAL_SUCCESS`
  - 统计字段正确

### P0-7 删除检测与软删除
- 目标：扫描后对不存在文件做软删除标记。
- 前置依赖：P0-4、P0-6
- 交付物：
  - `scan_task_seen_file` 写入逻辑
  - 软删除 SQL
- 验收标准：
  - WebDAV 删除文件后，`track.is_deleted=1`

### P0-8 基础查询 API（播放器可用）
- 目标：实现列表、搜索、详情查询。
- 前置依赖：P0-4
- 交付物：
  - `GET /api/v1/tracks`
  - `GET /api/v1/tracks/search`
  - `GET /api/v1/tracks/{id}`
- 验收标准：
  - 支持分页、关键词、条件筛选
  - 默认过滤软删除记录

### P0-9 最小安全与日志
- 目标：接口 Token 鉴权、密码脱敏、关键日志字段统一。
- 前置依赖：P0-3、P0-8
- 交付物：
  - Spring Security 最小 Token 拦截
  - 统一错误码与日志格式
- 验收标准：
  - 未授权请求被拒绝
  - 日志不出现明文密码

### P0-10 核心测试与上线验收
- 目标：完成主链路单测/集成测试并执行一次预发全量扫描。
- 前置依赖：P0-1 至 P0-9
- 交付物：
  - 单元测试（指纹/状态机/回退规则）
  - 集成测试（WebDAV->入库->查询）
- 验收标准：
  - 核心用例通过
  - 满足 PRD AC-001~AC-005

## 4. P1 任务（高优先增强）

### P1-1 增量扫描能力
- 目标：基于 `path+etag` 或 `path+mtime+size` 比较变化，仅处理变更文件。
- 前置依赖：P0 完成
- 验收标准：
  - 重复扫描无脏写
  - 增量耗时明显低于全量

### P1-2 扫描任务取消与重试
- 目标：支持取消任务，网络抖动场景支持指数退避重试。
- 前置依赖：P0-6
- 验收标准：
  - 任务可安全停止
  - 单文件失败不阻断整体任务

### P1-3 文件级失败明细与重跑
- 目标：完善 `scan_task_item` 失败明细，并提供按任务重试失败文件能力。
- 前置依赖：P0-6
- 验收标准：
  - 可定位失败 path/错误码
  - 重试后状态可回收

### P1-4 定时调度与单实例互斥
- 目标：支持每日自动增量扫描，防止并发重复跑任务。
- 前置依赖：P1-1
- 验收标准：
  - 定时任务可触发
  - 同时仅一个 RUNNING 任务

### P1-5 监控指标完善
- 目标：输出任务成功率、平均耗时、失败率等指标。
- 前置依赖：P0-10
- 验收标准：
  - Actuator/Micrometer 指标可见
  - 可按任务维度排障

## 5. P2 任务（优化演进）

### P2-1 查询性能优化
- 目标：根据真实数据分布优化索引、SQL、分页策略。
- 前置依赖：P0-8、P1-1
- 验收标准：
  - 常见查询 P95 < 300ms

### P2-2 内容哈希去重策略
- 目标：引入 `content_hash` 计算策略，识别“同内容不同路径”重复歌曲。
- 前置依赖：P1-1
- 验收标准：
  - 可配置开启/关闭
  - 不显著拖慢扫描主链路

### P2-3 任务并行度调优
- 目标：按目录或批次并发解析，提升大库扫描吞吐。
- 前置依赖：P1-1、P1-5
- 验收标准：
  - 在不增加失败率前提下提升吞吐

### P2-4 运维能力增强
- 目标：补充审计日志、慢查询监控、容量预警。
- 前置依赖：P1-5
- 验收标准：
  - 可观测性报表能支撑日常运维

## 6. 并行开发建议（2 人后端）
1. 开发 A：
   - P0-1、P0-2、P0-6、P0-9
2. 开发 B：
   - P0-3、P0-4、P0-5、P0-7、P0-8
3. 联调阶段：
   - P0-10（共同完成）

## 7. 建议排期（4 周）
1. 第 1 周：P0-1、P0-2、P0-3
2. 第 2 周：P0-4、P0-5、P0-6
3. 第 3 周：P0-7、P0-8、P0-9
4. 第 4 周：P0-10 + P1-1（如有余量）

## 8. 上线门槛（DoD）
- P0 全部完成并通过测试。
- 至少完成一次全量扫描 + 一次增量扫描回归验证。
- 接口鉴权、密码加密、健康检查均启用。
- 关键指标可观测，出现失败可定位到任务与文件。

