# WebDAV 音频扫描工具需求分析文档（PRD）

## 1. 文档信息
- 文档名称：WebDAV 音频扫描工具需求分析
- 版本：v1.0
- 日期：2026-02-08
- 状态：草案（可直接进入技术设计）

## 2. 项目背景
需要构建一个可持续运行的 WebDAV 扫描工具，用于扫描指定目录下的音频文件，提取歌曲元数据并存储到数据库，为音乐播放器提供可检索、可同步的云端音乐库。

当前痛点：
- 本地播放器难以直接管理多设备共享的 WebDAV 音乐文件。
- 无统一云数据库，导致搜索、去重、统计和跨端同步能力不足。
- 扫描过程不稳定时容易丢失进度或重复入库。

## 3. 项目目标与非目标

### 3.1 项目目标
- 支持连接 WebDAV 服务并递归扫描指定目录中的音频文件。
- 将文件信息与音频标签（Tag）结构化入库，形成可查询的云音乐数据库。
- 提供全量扫描与增量扫描机制，降低重复扫描成本。
- 为音乐播放器提供稳定的数据读取接口（歌曲列表、搜索、筛选、详情）。
- 具备基础可观测性（任务状态、扫描日志、错误统计）。

### 3.2 非目标（第一期不做）
- 不做在线播放转码服务。
- 不做歌词抓取与专辑封面在线补全。
- 不做复杂推荐算法与社交功能。
- 不做多租户企业级权限模型（仅单用户或轻量家庭场景）。

## 4. 目标用户与使用场景

### 4.1 目标用户
- 个人用户：有 WebDAV 云盘（NAS、网盘）并希望跨设备管理音乐库。
- 小型家庭用户：多人共用同一音乐资源目录。

### 4.2 核心场景
1. 首次配置 WebDAV 地址、账号、根目录后执行全量扫描。
2. 每日或手动触发增量扫描，仅同步新增/修改/删除文件。
3. 播放器按歌名、歌手、专辑、流派搜索云数据库并展示结果。
4. 用户查看扫描任务报告，定位失败文件并重试。

## 5. 业务范围与系统边界

### 5.1 业务范围（In Scope）
- WebDAV 目录遍历与文件发现
- 音频文件识别与元数据提取
- 数据去重、入库、更新、软删除
- 扫描任务管理与状态追踪
- 对播放器提供查询 API

### 5.2 系统边界（Out of Scope）
- 音频解码播放引擎（由播放器负责）
- 第三方音乐平台曲库聚合
- 复杂运维平台（先用日志+基础监控）

## 6. 功能需求

### 6.1 WebDAV 连接管理
- FR-001：支持配置 WebDAV `base_url`、用户名、密码/Token、根目录。
- FR-002：支持连接测试（鉴权验证、目录可读校验）。
- FR-003：支持连接超时、重试与失败提示。
- FR-004：支持敏感信息加密存储（至少密码加密）。

### 6.2 扫描任务管理
- FR-005：支持创建扫描任务（全量/增量）。
- FR-006：任务状态机：`PENDING` -> `RUNNING` -> `SUCCESS|FAILED|PARTIAL_SUCCESS|CANCELED`。
- FR-007：支持任务取消与安全停止（保留已完成进度）。
- FR-008：任务记录统计信息：扫描文件数、新增数、更新数、删除数、失败数、耗时。

### 6.3 文件发现与过滤
- FR-009：递归遍历指定目录。
- FR-010：仅识别支持的音频扩展名（如 `mp3/flac/m4a/aac/ogg/wav`，可配置）。
- FR-011：支持忽略规则（隐藏目录、临时文件、黑名单目录）。
- FR-012：识别文件唯一性依据：`path + etag/last_modified + size`（可按服务能力降级）。

### 6.4 元数据提取
- FR-013：提取基础文件信息：路径、文件名、大小、修改时间、ETag、MIME。
- FR-014：提取音频标签：标题、歌手、专辑、专辑歌手、曲号、年份、流派、时长、码率、采样率、声道、封面存在标记。
- FR-015：标签缺失时采用回退规则（标题默认文件名、未知歌手等）。

### 6.5 数据入库与同步
- FR-016：首次扫描完成全量入库。
- FR-017：增量扫描时只处理新增或变更文件。
- FR-018：文件从 WebDAV 删除后，数据库执行软删除（`is_deleted=true`）。
- FR-019：处理重复文件（同路径重复扫描、同内容不同路径）并可配置去重策略。
- FR-020：保证任务级幂等，重复执行不产生脏数据。

### 6.6 查询服务（供播放器）
- FR-021：歌曲列表分页查询（按更新时间、标题等排序）。
- FR-022：关键词搜索（标题、歌手、专辑）。
- FR-023：条件筛选（歌手、专辑、流派、年份）。
- FR-024：歌曲详情查询（包含 WebDAV 文件定位信息）。
- FR-025：仅返回有效歌曲（默认过滤软删除）。

### 6.7 可观测性与运维
- FR-026：记录任务级与文件级日志。
- FR-027：输出错误分类（网络错误、鉴权错误、解析错误、数据库错误）。
- FR-028：提供健康检查接口（服务可用、数据库连通）。
- FR-029：提供基础指标（任务成功率、平均扫描耗时、失败文件TopN）。

## 7. 非功能需求

### 7.1 性能
- NFR-001：10 万音频文件规模下支持稳定扫描。
- NFR-002：增量扫描平均耗时较全量下降 80% 以上（同等数据规模）。
- NFR-003：查询接口 P95 响应时间 < 300ms（常见筛选与分页场景）。

### 7.2 可靠性
- NFR-004：单次任务失败不影响历史数据可读性。
- NFR-005：任务中断可重试并从断点恢复（至少按目录或批次恢复）。
- NFR-006：数据库写入采用事务或批处理保障一致性。

### 7.3 安全
- NFR-007：传输必须使用 HTTPS（生产环境强制）。
- NFR-008：WebDAV 凭证加密存储，日志中禁止明文输出。
- NFR-009：接口访问需鉴权（至少 Token 级别）。

### 7.4 可维护性
- NFR-010：模块化设计（连接层、扫描层、解析层、存储层、API 层）。
- NFR-011：关键流程具备单元测试与集成测试。
- NFR-012：错误码和日志格式标准化，便于排障。

## 8. 数据需求与数据模型（逻辑）

### 8.1 核心实体
1. `scan_task`
   - `id`
   - `type` (`FULL|INCREMENTAL`)
   - `status`
   - `start_time` `end_time`
   - `total_files` `added_count` `updated_count` `deleted_count` `failed_count`
   - `error_summary`
2. `track`
   - `id`
   - `source_path`（WebDAV 相对路径，唯一索引之一）
   - `source_etag` `source_last_modified` `source_size`
   - `title` `artist` `album` `album_artist` `track_no` `year` `genre`
   - `duration_sec` `bitrate` `sample_rate` `channels`
   - `mime_type`
   - `content_hash`（可选，用于增强去重）
   - `is_deleted`
   - `created_at` `updated_at`
3. `scan_task_item`（可选，建议保留）
   - `id` `task_id` `path` `status` `error_code` `error_message`

### 8.2 索引建议
- `track(source_path)` 唯一索引
- `track(title, artist, album)` 组合索引（搜索）
- `track(updated_at)` 索引（增量与排序）
- `scan_task(start_time)` 索引

## 9. 接口需求（示例级）

### 9.1 管理接口
- `POST /api/v1/webdav/test`：测试连接
- `POST /api/v1/scan/tasks`：创建扫描任务
- `GET /api/v1/scan/tasks/{id}`：查询任务详情
- `POST /api/v1/scan/tasks/{id}/cancel`：取消任务

### 9.2 数据查询接口
- `GET /api/v1/tracks`：分页列表+筛选
- `GET /api/v1/tracks/search?q=...`：关键词检索
- `GET /api/v1/tracks/{id}`：歌曲详情

## 10. 关键业务流程

### 10.1 全量扫描流程
1. 验证 WebDAV 配置与目录权限。
2. 创建任务记录并置为 `RUNNING`。
3. 分批遍历文件并过滤非音频。
4. 抽取元数据并批量写入数据库。
5. 标记已不存在文件为软删除。
6. 汇总结果并结束任务。

### 10.2 增量扫描流程
1. 获取上次成功扫描快照点。
2. 比对路径+etag/mtime+size 识别变化。
3. 仅处理新增、更新和删除项。
4. 输出增量报告。

## 11. 异常与容错
- WebDAV 连接失败：任务快速失败并给出错误码。
- 扫描中网络抖动：按文件批次重试（指数退避，最大重试次数可配）。
- 单文件解析失败：记录失败项，不阻断整批任务。
- 数据库短时异常：批次级重试，超过阈值任务标记 `PARTIAL_SUCCESS` 或 `FAILED`。

## 12. 验收标准（UAT）
- AC-001：可成功连接目标 WebDAV 并扫描指定目录。
- AC-002：全量扫描后，数据库歌曲数量与可识别音频文件数量一致（误差仅来自损坏文件）。
- AC-003：新增或修改音频文件后，增量扫描可正确更新。
- AC-004：删除 WebDAV 文件后，数据库对应歌曲标记为软删除。
- AC-005：播放器可通过 API 完成分页、搜索、筛选和详情查询。
- AC-006：任务日志可定位失败原因，失败文件支持重试后恢复。

## 13. 测试需求

### 13.1 功能测试
- WebDAV 鉴权成功/失败场景
- 不同音频格式解析正确性
- 全量、增量、取消任务行为
- 删除与软删除一致性

### 13.2 性能测试
- 10 万文件目录下首扫与增量耗时
- 并发查询下 API 延迟与吞吐

### 13.3 稳定性测试
- 网络抖动、超时、断连恢复
- 数据库暂时不可用恢复能力

## 14. 里程碑建议
1. M1（1 周）：需求冻结 + 技术方案评审 + 数据库模型定稿
2. M2（2 周）：WebDAV 扫描与元数据解析核心链路完成
3. M3（1 周）：增量同步、任务管理、日志监控完成
4. M4（1 周）：查询 API、测试验收、上线准备

## 15. 风险与应对
- 风险：不同 WebDAV 服务对 ETag/mtime 支持差异大  
  应对：提供多策略指纹（etag 优先，mtime+size 兜底）。
- 风险：大目录扫描耗时长  
  应对：分批并行扫描、断点续扫、增量优先。
- 风险：音频标签质量参差不齐  
  应对：定义默认值和清洗规则，支持后续人工修正。

## 16. 待确认项
- 是否需要多用户隔离（账号维度数据隔离）。
- 是否需要保存专辑封面二进制到对象存储。
- 是否要求对接现有播放器账号体系（SSO/JWT）。
- 是否有上线环境约束（MySQL/PostgreSQL/SQLite、部署在 NAS 或云服务器）。

---

该文档用于需求分析阶段，可在确认“待确认项”后进入技术设计（架构图、表结构 DDL、接口契约、任务调度方案）。
